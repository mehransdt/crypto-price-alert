<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Monitor - Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Crypto Price Monitor</h1>
            <div class="user-info">
                <span id="username"></span>
                <a href="/settings">Settings</a>
                <a href="#" id="logoutBtn">Logout</a>
            </div>
        </header>

        <!-- Coin Search Section at Top -->
        <div class="coin-search-section">
            <h2>Add New Alert</h2>
            <div class="search-container">
                <input type="text" id="coinSearch" placeholder="Search for a cryptocurrency...">
                <button id="searchBtn">Search</button>
            </div>
            <div id="searchResults" class="search-results"></div>
        </div>

        <!-- Your Alerts Section -->
        <div class="alerts-main-section">
            <div class="alerts-header">
                <h2>Your Alerts</h2>
                <div class="alerts-search-container">
                    <input type="text" id="alertSearch" placeholder="Search your alerts...">
                </div>
            </div>
            <div id="alertsList" class="alerts-list"></div>
        </div>
    </div>

    <!-- Add/Edit Alert Modal -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Add New Alert</h2>
            <form id="alertForm">
                <input type="hidden" id="alertId">
                <div class="form-group">
                    <label for="coinName">Coin</label>
                    <input type="text" id="coinName" readonly>
                    <input type="hidden" id="coinId">
                </div>
                <div class="form-group">
                    <label for="currentPrice">Current Price (USD)</label>
                    <input type="text" id="currentPrice" readonly>
                </div>
                
                <!-- Target Prices Section -->
                <div class="targets-section">
                    <div class="targets-header">
                        <label>Target Prices</label>
                        <button type="button" id="addTargetBtn" class="btn-add-target">+ Add Target</button>
                    </div>
                    <div id="targetsList" class="targets-list">
                        <!-- Target rows will be added here dynamically -->
                    </div>
                </div>
                
                <button type="submit" class="btn-primary">Save Alert</button>
            </form>
        </div>
    </div>

    <script>
        let token = localStorage.getItem('token');
        let selectedCoin = null;
        let alertTargets = [];

        // Check if user is logged in
        if (!token) {
            window.location.href = '/';
        }

        // Set username
        document.getElementById('username').textContent = localStorage.getItem('username');

        // Logout functionality
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = '/';
        });

        // Load user alerts
        const loadAlerts = async () => {
            try {
                const response = await fetch('/api/alerts', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const alerts = await response.json();
                displayAlerts(alerts);
            } catch (error) {
                console.error('Error loading alerts:', error);
            }
        };

        // Display alerts
        const displayAlerts = (alerts) => {
            const alertsList = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                alertsList.innerHTML = '<p class="no-alerts">No alerts set up yet. Use the search above to add your first alert!</p>';
                return;
            }
            
            alertsList.innerHTML = alerts.map(alert => {
                const triggeredTargets = alert.targets.filter(t => t.is_triggered).length;
                const totalTargets = alert.targets.length;
                const alertClass = triggeredTargets > 0 ? 'alert-item triggered' : 'alert-item';
                
                const targetsHtml = alert.targets.map(target => {
                    const statusIcon = target.is_triggered ? '‚úÖ' : '‚è≥';
                    const alertTypeMap = {
                        'Profit target': 'ŸáÿØŸÅ ÿ≥ŸàÿØ',
                        'Loss limit': 'ÿ≠ÿØ ÿ∂ÿ±ÿ±',
                        'Watch Market': 'ŸÜÿ∏ÿßÿ±ÿ™ ÿ®ÿßÿ≤ÿßÿ±',
                        'Target': 'ŸáÿØŸÅ',
                        'Step buy': 'ÿÆÿ±€åÿØ ŸæŸÑ⁄©ÿßŸÜ€å',
                        'Step sell': 'ŸÅÿ±Ÿàÿ¥ ŸæŸÑ⁄©ÿßŸÜ€å',
                        'custom': 'ÿ≥ŸÅÿßÿ±ÿ¥€å'
                    };
                    const alertTypeText = alertTypeMap[target.alert_type] || target.alert_type;
                    const toleranceText = target.tolerance ? `(¬±${target.tolerance}%)` : '';
                    const descriptionText = target.description ? ` - ${target.description}` : '';
                    
                    return `
                        <div class="target-row ${target.is_triggered ? 'triggered' : ''}">
                            <span class="target-info">
                                ${statusIcon} $${target.target_price} - ${alertTypeText} ${toleranceText}${descriptionText}
                            </span>
                            ${target.triggered_at ? `<span class="trigger-time">${new Date(target.triggered_at).toLocaleString('fa-IR')}</span>` : ''}
                        </div>
                    `;
                }).join('');
                
                return `
                    <div class="${alertClass}">
                        <div class="alert-info">
                            <h3>${alert.coin_name} (${alert.coin_symbol.toUpperCase()})</h3>
                            <div class="targets-display">
                                ${targetsHtml}
                            </div>
                            <p class="alert-status">üí∞ Current: <span id="current-${alert.coin_id}">Loading...</span> | Targets: ${triggeredTargets}/${totalTargets} triggered</p>
                        </div>
                        <div class="alert-actions">
                            <button class="btn-edit" data-alert='${JSON.stringify(alert)}'>Edit</button>
                            <button class="btn-delete" data-id="${alert.id}">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const alert = JSON.parse(e.target.dataset.alert);
                    openAlertModal(alert);
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.target.dataset.id;
                    deleteAlert(id);
                });
            });
            
            // Load current prices for alerts
            alerts.forEach(alert => {
                loadCurrentPrice(alert.coin_id, `current-${alert.coin_id}`);
            });
        };

        // Filter alerts based on search
        const filterAlerts = (searchTerm) => {
            const alertItems = document.querySelectorAll('.alert-item');
            alertItems.forEach(item => {
                const coinName = item.querySelector('h3').textContent.toLowerCase();
                if (coinName.includes(searchTerm.toLowerCase())) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        };

        // Alert search functionality
        document.getElementById('alertSearch').addEventListener('input', (e) => {
            filterAlerts(e.target.value);
        });

        // Load current price for a coin
        const loadCurrentPrice = async (coinId, elementId) => {
            try {
                const response = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coinId}&vs_currencies=usd`);
                const data = await response.json();
                const price = data[coinId]?.usd;
                
                if (price !== undefined) {
                    document.getElementById(elementId).textContent = `$${price}`;
                }
            } catch (error) {
                console.error('Error loading price:', error);
                document.getElementById(elementId).textContent = 'Error';
            }
        };

        // Search coins
        document.getElementById('searchBtn').addEventListener('click', async () => {
            const query = document.getElementById('coinSearch').value.trim();
            if (!query) return;
            
            try {
                const response = await fetch(`/api/coins/search?query=${encodeURIComponent(query)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const coins = await response.json();
                displaySearchResults(coins);
            } catch (error) {
                console.error('Error searching coins:', error);
                alert('Error searching coins');
            }
        });

        // Display search results
        const displaySearchResults = (coins) => {
            const searchResults = document.getElementById('searchResults');
            
            if (coins.length === 0) {
                searchResults.innerHTML = '<p>No coins found.</p>';
                return;
            }
            
            searchResults.innerHTML = coins.map(coin => `
                <div class="coin-item">
                    <img src="${coin.large}" alt="${coin.name}" width="24" height="24">
                    <div class="coin-info">
                        <h3>${coin.name} (${coin.symbol.toUpperCase()})</h3>
                    </div>
                    <button class="btn-add-alert" data-coin='${JSON.stringify({
                        id: coin.id,
                        name: coin.name,
                        symbol: coin.symbol
                    })}'>Add Alert</button>
                </div>
            `).join('');
            
            // Add event listeners for add alert buttons
            document.querySelectorAll('.btn-add-alert').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const coin = JSON.parse(e.target.dataset.coin);
                    
                    // Get current price for the coin
                    try {
                        const priceResponse = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${coin.id}&vs_currencies=usd`);
                        const priceData = await priceResponse.json();
                        const currentPrice = priceData[coin.id]?.usd;
                        
                        if (currentPrice !== undefined) {
                            coin.current_price = currentPrice;
                            openAlertModal(null, coin);
                        } else {
                            alert('Could not fetch current price for this coin');
                        }
                    } catch (error) {
                        console.error('Error fetching price:', error);
                        alert('Error fetching current price');
                    }
                });
            });
        };

        // Add target row
        const addTargetRow = (target = null) => {
            const targetsList = document.getElementById('targetsList');
            const targetIndex = alertTargets.length;
            
            const targetData = target || {
                target_price: '',
                alert_type: 'profit target',
                tolerance: 1.0
            };
            
            alertTargets.push(targetData);
            
            const targetRow = document.createElement('div');
            targetRow.className = 'target-row';
            targetRow.innerHTML = `
                <div class="target-inputs">
                    <input type="number" class="target-price" placeholder="Target Price" step="0.01" value="${targetData.target_price}" required>
                    <select class="alert-type">
                        <option value="Profit target" ${targetData.alert_type === 'Profit target' ? 'selected' : ''}>Profit target</option>
                        <option value="Loss limit" ${targetData.alert_type === 'Loss limit' ? 'selected' : ''}>Loss limit</option>
                        <option value="Watch Market" ${targetData.alert_type === 'Watch Market' ? 'selected' : ''}>Watch Market</option>
                        <option value="Target" ${targetData.alert_type === 'Target' ? 'selected' : ''}>Target</option>
                        <option value="Step buy" ${targetData.alert_type === 'Step buy' ? 'selected' : ''}>Step buy</option>
                        <option value="Step sell" ${targetData.alert_type === 'Step sell' ? 'selected' : ''}>Step sell</option>
                        <option value="custom" ${targetData.alert_type === 'custom' ? 'selected' : ''}>custom</option>
                    </select>
                    <input type="number" class="tolerance" placeholder="Tolerance % (optional)" step="0.1" min="0" max="100" value="${targetData.tolerance || ''}">
                    <input type="text" class="description" placeholder="Description (optional)" value="${targetData.description || ''}">
                    <button type="button" class="btn-remove-target" data-index="${targetIndex}">√ó</button>
                </div>
            `;
            
            targetsList.appendChild(targetRow);
            
            // Add remove functionality
            targetRow.querySelector('.btn-remove-target').addEventListener('click', (e) => {
                const index = parseInt(e.target.dataset.index);
                alertTargets.splice(index, 1);
                targetRow.remove();
                updateTargetIndices();
            });
        };

        // Update target indices after removal
        const updateTargetIndices = () => {
            const removeButtons = document.querySelectorAll('.btn-remove-target');
            removeButtons.forEach((btn, index) => {
                btn.dataset.index = index;
            });
        };

        // Add target button functionality
        document.getElementById('addTargetBtn').addEventListener('click', () => {
            addTargetRow();
        });

        // Open alert modal
        const openAlertModal = async (alert = null, coin = null) => {
            const modal = document.getElementById('alertModal');
            const modalTitle = document.getElementById('modalTitle');
            const targetsList = document.getElementById('targetsList');
            
            // Clear previous targets
            targetsList.innerHTML = '';
            alertTargets = [];
            
            if (alert) {
                // Edit mode
                modalTitle.textContent = 'Edit Alert';
                document.getElementById('alertId').value = alert.id;
                document.getElementById('coinId').value = alert.coin_id;
                document.getElementById('coinName').value = `${alert.coin_name} (${alert.coin_symbol.toUpperCase()})`;
                document.getElementById('currentPrice').value = 'Loading...';
                
                // Add existing targets
                alert.targets.forEach(target => {
                    addTargetRow(target);
                });
                
                // If no targets, add one empty target
                if (alert.targets.length === 0) {
                    addTargetRow();
                }
                
                // Load current price for edit mode
                try {
                    const priceResponse = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${alert.coin_id}&vs_currencies=usd`);
                    const priceData = await priceResponse.json();
                    const currentPrice = priceData[alert.coin_id]?.usd;
                    
                    if (currentPrice !== undefined) {
                        document.getElementById('currentPrice').value = `$${currentPrice}`;
                    } else {
                        document.getElementById('currentPrice').value = 'Error loading price';
                    }
                } catch (error) {
                    console.error('Error fetching current price:', error);
                    document.getElementById('currentPrice').value = 'Error loading price';
                }
            } else if (coin) {
                // Add mode
                modalTitle.textContent = 'Add New Alert';
                document.getElementById('alertId').value = '';
                document.getElementById('coinId').value = coin.id;
                document.getElementById('coinName').value = `${coin.name} (${coin.symbol.toUpperCase()})`;
                document.getElementById('currentPrice').value = `$${coin.current_price}`;
                
                // Add one empty target
                addTargetRow();
            }
            
            modal.style.display = 'block';
        };

        // Close modal
        document.querySelector('.close').addEventListener('click', () => {
            document.getElementById('alertModal').style.display = 'none';
        });

        // Close modal when clicking outside
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('alertModal');
            if (e.target === modal) {
                modal.style.display = 'none';
            }
        });

        // Handle alert form submission
        document.getElementById('alertForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            console.log('Form submitted'); // Debug log
            
            const alertId = document.getElementById('alertId').value;
            const coinId = document.getElementById('coinId').value;
            const coinName = document.getElementById('coinName').value.split(' (')[0];
            const coinSymbol = document.getElementById('coinName').value.split(' (')[1].split(')')[0];
            
            console.log('Alert data:', { alertId, coinId, coinName, coinSymbol }); // Debug log
            
            // Collect targets from form
            const targetRows = document.querySelectorAll('.target-inputs');
            const targets = [];
            
            console.log('Found target rows:', targetRows.length); // Debug log
            
            targetRows.forEach((row, index) => {
                const targetPrice = row.querySelector('.target-price').value;
                const alertType = row.querySelector('.alert-type').value;
                const tolerance = row.querySelector('.tolerance').value;
                const description = row.querySelector('.description').value;
                
                console.log(`Target ${index}:`, { targetPrice, alertType, tolerance, description }); // Debug log
                
                if (targetPrice && alertType) {
                    targets.push({
                        target_price: parseFloat(targetPrice),
                        alert_type: alertType,
                        tolerance: tolerance ? parseFloat(tolerance) : 1.0,
                        description: description || null
                    });
                }
            });
            
            console.log('Collected targets:', targets); // Debug log
            
            if (targets.length === 0) {
                alert('Please add at least one target');
                return;
            }
            
            try {
                let response;
                const requestData = alertId ? 
                    { targets } : 
                    { 
                        coin_id: coinId,
                        coin_name: coinName,
                        coin_symbol: coinSymbol,
                        targets
                    };
                
                console.log('Request data:', requestData); // Debug log
                
                if (alertId) {
                    // Update existing alert
                    response = await fetch(`/api/alerts/${alertId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(requestData)
                    });
                } else {
                    // Create new alert
                    response = await fetch('/api/alerts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(requestData)
                    });
                }
                
                console.log('Response status:', response.status); // Debug log
                
                const data = await response.json();
                console.log('Response data:', data); // Debug log
                
                if (response.ok) {
                    alert('Alert saved successfully!');
                    document.getElementById('alertModal').style.display = 'none';
                    document.getElementById('searchResults').innerHTML = '';
                    document.getElementById('coinSearch').value = '';
                    loadAlerts(); // Refresh alerts list
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error saving alert:', error);
                alert('An error occurred. Please try again.');
            }
        });

        // Delete alert
        const deleteAlert = async (id) => {
            if (!confirm('Are you sure you want to delete this alert?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/alerts/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    loadAlerts(); // Refresh alerts list
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                console.error('Error deleting alert:', error);
                alert('An error occurred. Please try again.');
            }
        };

        // Initial load
        loadAlerts();
    </script>
</body>
</html>
